"use strict";(self.webpackChunkopendata_backend_prabulinggih=self.webpackChunkopendata_backend_prabulinggih||[]).push([[1613],{20665:(e,t,i)=>{i.d(t,{A:()=>f});var s=i(37055),l=i(35143),a=i(91967),r=i(18690),n=i(98773),o=i(94643),d=i(46053),u=(i(81806),i(76460),i(85842)),c=i(53430),p=i(76386);let f=class extends a.A{constructor(e){super(e),this._featureUtils=null,this.effectivePopupTemplate=null}get _arcadeTask(){return this.expressionsUsedInTitle.length>0?this._get("_arcadeTask")||(0,n.UT)(()=>(0,p.l)()):null}get featureUtilsPromise(){var e;return null!==(e=this._get("featureUtilsPromise"))&&void 0!==e?e:i.e(9912).then(i.bind(i,9912)).then(e=>this._featureUtils=e)}get calculatedExpressions(){var e;const t=new o.A;if(!this.expressionsUsedInTitle.length)return t;if(null===(e=this._arcadeTask)||void 0===e||!e.value){for(const e of null!==(i=this.expressionsUsedInTitle)&&void 0!==i?i:[]){var i;t.push({name:e.name,invalid:!0})}return t}for(const l of this.expressionsUsedInTitle)try{const e=this._arcadeTask.value.arcade.parseScript(l.expression,["$layer","$map","$datastore"]);if(e.isAsync){t.push({name:l.name,invalid:!0});break}t.push({name:l.name,syntax:e,invalid:!1,func:this._arcadeTask.value.arcade.compileScript(e,{vars:{$feature:"any"}})})}catch(s){t.push({name:l.name,invalid:!0});break}return t}get expressionsUsedInTitle(){var e,t,i,s;let l=null!==(e=null===(t=this.effectivePopupTemplate)||void 0===t?void 0:t.title)&&void 0!==e?e:"";return"string"!=typeof l?[]:(l=l.toLowerCase(),null!==(i=null===(s=this.effectivePopupTemplate)||void 0===s||null===(s=s.expressionInfos)||void 0===s?void 0:s.filter(e=>l.includes("{expression/".concat(e.name.toLowerCase(),"}"))))&&void 0!==i?i:[])}get fieldInfoMap(){return this._featureUtils?this._createFieldInfoMap(this._featureUtils.getAllFieldInfos(this.effectivePopupTemplate)):null}get hasBadExpressions(){return this.calculatedExpressions.some(e=>!0===e.invalid)}get requiredFields(){var e;const t=new Set;if(null!==(e=this._arcadeTask)&&void 0!==e&&e.value&&!this.hasBadExpressions)for(const n of null!==(i=null===(s=this.calculatedExpressions)||void 0===s?void 0:s.toArray())&&void 0!==i?i:[]){var i,s;try{const e=this._arcadeTask.value.arcade.extractFieldLiterals(n.syntax);for(const i of e){var l;const e=i.split("."),s=this.fieldsIndex.get(null!==(l=e.at(-1))&&void 0!==l?l:"");s&&t.add(s.name)}}catch(r){}}const a=this._extractFieldNames(this.workingTitle);for(const n of a){const e=this.fieldsIndex.get(n);e&&t.add(e.name)}return null!=this.objectIdField&&t.add(this.objectIdField),t}get titleFromDisplayField(){var e,t,i,s;let l="";return this.displayField&&(l=null!==(e=null===(t=this.fieldsIndex.get(this.displayField))||void 0===t?void 0:t.name)&&void 0!==e?e:""),l||(l=null!==(i=null===(s=this.fieldsIndex.get(this.objectIdField))||void 0===s?void 0:s.name)&&void 0!==i?i:""),l?"{".concat(l,"}"):""}get workingTitle(){const e=this.effectivePopupTemplate?this.effectivePopupTemplate.title:"";return""===e||null==e||this.hasBadExpressions||"string"!=typeof e?this.titleFromDisplayField:e}async getTitle(e,t,i){var s,l;const a=null!==(s=t.getObjectId())&&void 0!==s?s:t.attributes[e.objectIdField];return null!==(l=(await this.getTitles(e,[t],i)).get(a))&&void 0!==l?l:""}async getTitles(e,t,i){var s;const l=new Map,a=null!==(s=null===i||void 0===i?void 0:i.timeZone)&&void 0!==s?s:"system";try{var r;const[{substituteFieldsInLinksAndAttributes:s}]=await Promise.all([this.featureUtilsPromise,null===(r=this._arcadeTask)||void 0===r?void 0:r.promise]);(null===i||void 0===i?void 0:i.fetchMissingFields)&&(t=await this._checkAndReQueryGraphics(e,t));const{fieldInfoMap:n,workingTitle:o}=this,d=o&&n;t.forEach(t=>{var i;const r=null!==(i=t.getObjectId())&&void 0!==i?i:t.attributes[e.objectIdField],u=d?s({attributes:t.attributes,expressionAttributes:null,fieldInfoMap:n,globalAttributes:this._createFormattedAttributes(e,t,a).global,layer:e,text:o}):"";l.set(r,u)})}catch(n){}return l}async _checkAndReQueryGraphics(e,t){const i=t.map(t=>{var i;return null!==(i=t.getObjectId())&&void 0!==i?i:t.attributes[e.objectIdField]}).filter(r.Ru);if(i.length!==t.length)return t;if(t.some(e=>!(0,c.Kl)(e,this.requiredFields))){const s=e.createQuery();s.where="1=1",s.outFields=[...this.requiredFields],s.objectIds=i;const l=await e.queryFeatures(s);if((null===l||void 0===l?void 0:l.features.length)===t.length)return l.features}return t}_createFieldInfoMap(e){const t=new Map;if(!e)return t;for(const s of e){var i;if(!s.fieldName)continue;const e=this.fieldsIndex.get(s.fieldName),l=null!==(i=null===e||void 0===e?void 0:e.name)&&void 0!==i?i:s.fieldName;s.fieldName=l,t.set(l.toLowerCase(),s)}return t}_createFormattedAttributes(e,t){var i,l,a;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"system";const n=null!==(i=null===(l=this.effectivePopupTemplate)||void 0===l?void 0:l.fieldInfos)&&void 0!==i?i:[],o={};if(!this._featureUtils)return{};if(!this.hasBadExpressions&&this.calculatedExpressions.length>0&&null!==(a=this._arcadeTask)&&void 0!==a&&a.value){const i=this._arcadeTask.value.Feature.createFromGraphicLikeObject(t.geometry,t.attributes,e,null);for(const e of this.calculatedExpressions)try{o["expression/".concat(e.name)]=e.func({vars:{$feature:i}})}catch(u){}}const d=(0,s.A)((0,s.A)({},t.attributes),o);return{global:this._featureUtils.formatAttributes({fieldInfos:n,attributes:d,graphic:t,timeZone:r,layer:e,fieldInfoMap:this.fieldInfoMap}),content:[]}}_extractFieldNames(e){return(0,c.nw)(e).filter(e=>!(0===e.indexOf("relationships/")||0===e.indexOf("expression/")))}};(0,l._)([(0,d.MZ)({readOnly:!0})],f.prototype,"_arcadeTask",null),(0,l._)([(0,d.MZ)()],f.prototype,"_featureUtils",void 0),(0,l._)([(0,d.MZ)({readOnly:!0})],f.prototype,"featureUtilsPromise",null),(0,l._)([(0,d.MZ)({readOnly:!0})],f.prototype,"calculatedExpressions",null),(0,l._)([(0,d.MZ)()],f.prototype,"displayField",void 0),(0,l._)([(0,d.MZ)()],f.prototype,"effectivePopupTemplate",void 0),(0,l._)([(0,d.MZ)()],f.prototype,"expressionsUsedInTitle",null),(0,l._)([(0,d.MZ)()],f.prototype,"fieldsIndex",void 0),(0,l._)([(0,d.MZ)()],f.prototype,"fieldInfoMap",null),(0,l._)([(0,d.MZ)()],f.prototype,"fields",void 0),(0,l._)([(0,d.MZ)()],f.prototype,"objectIdField",void 0),(0,l._)([(0,d.MZ)()],f.prototype,"requiredFields",null),f=(0,l._)([(0,u.$)("esri.layers.support.TitleCreator")],f)},61701:(e,t,i)=>{var s;i.d(t,{X:()=>s}),function(e){e[e.SAVE=0]="SAVE",e[e.SAVE_AS=1]="SAVE_AS"}(s||(s={}))}}]);
//# sourceMappingURL=1613.5bface54.chunk.js.map